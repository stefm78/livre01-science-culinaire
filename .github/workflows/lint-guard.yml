---
name: "⚙️ Lint Guard - ADN Quality Assurance"

on:
  workflow_dispatch: {}
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '.github/scripts/*'
      - '.github/templates/*.md'
      - 'constitution-projet-ai.md'
      - 'AI_CORE.yml'
      - 'README.md'

jobs:
  lint-workflows:
    name: "YAML Workflows"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Install yamllint"
        run: pip install yamllint

      - name: "Lint YAML files"
        run: |
          echo "=== YAML LINTING ==="
          if ls .github/workflows/*.yml 1> /dev/null 2>&1; then
          yamllint .github/workflows/ || {
          echo "❌ YAML lint errors found"
          echo "Fix syntax errors before merge"
          exit 1
          }
          echo "✅ YAML syntax OK"
          else
          echo "✅ No YAML workflows to check"
          fi

      - name: "Install actionlint"
        run: |
          set -euo pipefail
          ver="$(curl -s https://api.github.com/repos/rhysd/actionlint/releases/latest | jq -r .tag_name)"
          curl -fsSL "https://github.com/rhysd/actionlint/releases/download/${ver}/actionlint_${ver#v}_linux_amd64.tar.gz" -o actionlint.tgz
          sudo tar -xzf actionlint.tgz -C /usr/local/bin actionlint
          actionlint --version

      - name: "Lint GitHub Actions workflows"
        run: |
          echo "=== ACTIONS LINTING ==="
          if ls .github/workflows/*.yml 1> /dev/null 2>&1; then
          (cd .github/workflows && actionlint) || {
          echo "❌ Action lint errors found"
          echo "Fix workflow issues before merge"
          exit 1
          }
          echo "✅ Actions syntax OK"
          else
          echo "✅ No workflows to check"
          fi

  lint-scripts:
    name: "Scripts Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Install tools"
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck python3-yaml jq
          pip install pylint || true

      - name: "Make scripts executable"
        run: |
          if ls .github/scripts/*.sh 1> /dev/null 2>&1; then
          chmod +x .github/scripts/*.sh
          echo "✅ Shell scripts made executable"
          fi
          if ls .github/scripts/*.py 1> /dev/null 2>&1; then
          chmod +x .github/scripts/*.py
          echo "✅ Python scripts made executable"
          fi

      - name: "Lint shell scripts (ShellCheck)"
        run: |
          echo "=== SHELLCHECK ==="
          if ls .github/scripts/*.sh 1> /dev/null 2>&1; then
          shellcheck .github/scripts/*.sh || {
          echo "❌ ShellCheck issues found"
          exit 1
          }
          echo "✅ Shell scripts OK"
          else
          echo "✅ No shell scripts to check"
          fi

      - name: "Validate Python scripts"
        run: |
          echo "=== PYTHON SCRIPT VALIDATION ==="
          if ls .github/scripts/*.py 1> /dev/null 2>&1; then
          python3 -m py_compile .github/scripts/*.py || {
          echo "❌ Python syntax error"
          exit 1
          }
          echo "✅ Python scripts syntax OK"
          else
          echo "✅ No Python scripts to check"
          fi

  verify-adn-files:
    name: "ADN Vital Files"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Vérifier fichiers ADN vitaux"
        run: |
          echo "=== VÉRIFICATION FICHIERS ADN VITAUX ==="
          for f in "constitution-projet-ai.md" "AI_CORE.yml" "README.md"; do
          if [[ ! -f "$f" ]]; then echo "❌ MANQUANT: $f"; exit 1; fi
          if [[ ! -s "$f" ]]; then echo "❌ VIDE: $f"; exit 1; fi
          echo "✅ $f présent et non vide"
          done
          python3 .github/scripts/check-ai-core.py

  integration-test:
    name: "Integration Test"
    runs-on: ubuntu-latest
    needs:
      - lint-workflows
      - lint-scripts
      - verify-adn-files
    steps:
      - uses: actions/checkout@v4
      - name: "Sanity check scripts"
        run: |
          chmod +x .github/scripts/*.sh || true
          for s in .github/scripts/*.sh; do
          if [ -f "$s" ]; then
          bash -n "$s" || true
          fi
          done
          echo "✅ Integration sanity passed"
