name: "04-Images üí¨ Scan Backlog Commande"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  scan-on-command:
    name: "Scanner via commande /scan-images"
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/scan-images')
    runs-on: ubuntu-latest
    steps:
      - name: R√©action rocket au commentaire
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
            
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Installer d√©pendances
        run: pip install Pillow
        
      - name: Ex√©cuter scan backlog images
        id: scan
        run: |
          echo "üîç Lancement scan suite √† commande /scan-images..."
          python scripts/scan-images-backlog.py > scan_output.txt 2>&1
          echo "scan_complete=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Scan termin√©"
          
      - name: V√©rifier r√©sultats scan
        id: results
        run: |
          if [ -f "_inbox/images/BACKLOG-REPORT.md" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Poster r√©sultats dans l'issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## ‚ö†Ô∏è Erreur lors du scan';
            if (fs.existsSync('_inbox/images/BACKLOG-REPORT.md')) {
              report = fs.readFileSync('_inbox/images/BACKLOG-REPORT.md', 'utf8');
            }
            let consoleOutput = '';
            if (fs.existsSync('scan_output.txt')) {
              consoleOutput = fs.readFileSync('scan_output.txt', 'utf8');
            }
            const comment = `## ü§ñ Scan Backlog Images IA - R√©sultats\n\n${report}\n\n---\n\n<details>\n<summary>üìã Sortie console compl√®te</summary>\n\n\`\`\`\n${consoleOutput}\n\`\`\`\n\n</details>\n\n---\n\n**Rapports g√©n√©r√©s** :\n- üìÑ JSON : \`_inbox/images/backlog-scan.json\`\n- üìù Markdown : \`_inbox/images/BACKLOG-REPORT.md\`\n\n*D√©clench√© par @${context.payload.comment.user.login} via commande \`/scan-images\`*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
      - name: Commit et push rapports
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add _inbox/images/backlog-scan.json _inbox/images/BACKLOG-REPORT.md
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Aucun changement dans les rapports"
          else
            git pull --rebase origin main
            git commit -m "chore(images): scan backlog via commande /scan-images"
            git push
            echo "‚úÖ Rapports committ√©s"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: R√©action succ√®s (hooray)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'hooray'
            });
            
      - name: R√©action erreur (confused)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });
