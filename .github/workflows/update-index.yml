name: ğŸ“š Mise Ã  jour Index Recettes

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Raison de la mise Ã  jour (optionnel)'
        required: false
        default: 'Mise Ã  jour manuelle'

jobs:
  update-index:
    name: GÃ©nÃ©rer index.json et INDEX.md
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“Š GÃ©nÃ©rer index recettes
        run: |
          echo "ğŸš€ ExÃ©cution de generate-index.py..."
          python scripts/generate-index.py
          echo "âœ… Index gÃ©nÃ©rÃ© avec succÃ¨s"
      
      - name: ğŸ” VÃ©rifier changements
        id: git-check
        run: |
          if git diff --quiet recettes/index.json recettes/INDEX.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans l'index"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Changements dÃ©tectÃ©s dans l'index"
          fi
      
      - name: ğŸ“ Afficher diffÃ©rences
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "ğŸ“Š DiffÃ©rences dÃ©tectÃ©es :"
          git diff recettes/index.json recettes/INDEX.md
      
      - name: ğŸ’¾ Commit et push
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add recettes/index.json recettes/INDEX.md
          git commit -m "docs(recettes): mise Ã  jour automatique index - ${{ inputs.reason }}"
          git push
      
      - name: âœ… RÃ©sultat
        run: |
          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            echo "âœ… Index mis Ã  jour et committÃ© avec succÃ¨s"
          else
            echo "â„¹ï¸ Index dÃ©jÃ  Ã  jour, aucune modification nÃ©cessaire"
          fi
      
      - name: ğŸ“Š Afficher statistiques
        run: |
          echo "ğŸ“ˆ Statistiques actuelles :"
          python -c "
          import json
          with open('recettes/index.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          print(f\"  â€¢ Total recettes : {data['meta']['total_recettes']}\")
          print(f\"  â€¢ Total chapitres : {data['meta']['total_chapitres']}\")
          print(f\"  â€¢ DerniÃ¨re mise Ã  jour : {data['meta']['date_generation']}\")
          "
